<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PreferencesManager.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=0;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">debugAndroidTest</a> &gt; <a href="index.source.html" class="el_package">universum.studios.android.preference</a> &gt; <span class="el_source">PreferencesManager.java</span></div><h1>PreferencesManager.java</h1><pre class="source lang-java linenums">/*
 * =================================================================================================
 *                             Copyright (C) 2016 Universum Studios
 * =================================================================================================
 *         Licensed under the Apache License, Version 2.0 or later (further &quot;License&quot; only).
 * -------------------------------------------------------------------------------------------------
 * You may use this file only in compliance with the License. More details and copy of this License
 * you may retrieve at
 *
 * 		http://www.apache.org/licenses/LICENSE-2.0
 *
 * You can redistribute, modify or publish any part of the code written within this file but as it
 * is described in the License, the software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES or CONDITIONS OF ANY KIND.
 *
 * See the License for the specific language governing permissions and limitations under the License.
 * =================================================================================================
 */
package universum.studios.android.preference;

import android.content.Context;
import android.content.SharedPreferences;
import android.support.annotation.NonNull;
import android.support.annotation.Nullable;
import android.support.annotation.StringRes;

import java.util.Set;

/**
 * Manager which implements {@link SharedPreferencesFacade} along with {@link SharedPreferencesProvider}
 * in order to provide a simple API for putting and obtaining of values persisted within {@link SharedPreferences}.
 *
 * &lt;h3&gt;Shared preferences&lt;/h3&gt;
 * The PreferencesManager is closely associated with {@link SharedPreference}. Any implementation of
 * SharedPreference class may be used to represent a concrete preference value to be persisted in
 * shared preferences. Methods listed below may be used to put, get or remove a desired shared preference
 * into or from preferences managed by the preferences manager:
 * &lt;ul&gt;
 * &lt;li&gt;{@link #putPreference(SharedPreference, Object)}&lt;/li&gt;
 * &lt;li&gt;{@link #getPreference(SharedPreference)}&lt;/li&gt;
 * &lt;li&gt;{@link #containsPreference(SharedPreference)}&lt;/li&gt;
 * &lt;li&gt;{@link #removePreference(SharedPreference)}&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * &lt;h3&gt;Sample implementation&lt;/h3&gt;
 * &lt;pre&gt;
 * public final class AppPreferences extends PreferencesManager {
 *
 *      private static final String KEY_PREFIX = BuildConfig.APPLICATION_ID = &quot;.PREFERENCE.&quot;;
 *      private static final String KEY_APP_FIRST_LAUNCH = KEY_PREFIX + &quot;AppFirstLaunch&quot;;
 *
 *      public AppPreferences(@NonNull Context context) {
 *          super(context);
 *      }
 *
 *      public void setAppFirstLaunch(boolean firstLaunch) {
 *          putBoolean(KEY_APP_FIRST_LAUNCH, firstLaunch);
 *      }
 *
 *      public boolean isAppFirstLaunch() {
 *          return getBoolean(KEY_APP_FIRST_LAUNCH, true);
 *      }
 * }
 * &lt;/pre&gt;
 *
 * @author Martin Albedinsky
 */
public class PreferencesManager implements SharedPreferencesFacade, SharedPreferencesProvider {

	/*
	 * Constants ===================================================================================
	 */

	/**
	 * Log TAG.
	 */
	// private static final String TAG = &quot;PreferencesManager&quot;;

	/*
	 * Interface ===================================================================================
	 */

	/*
	 * Static members ==============================================================================
	 */

	/*
	 * Members =====================================================================================
	 */

	/**
	 * Context with which has been this manager created.
	 */
	private final Context mContext;

	/**
	 * File name of shared preferences managed by this manager.
	 */
	private String mPreferencesName;

	/**
	 * File mode of shared preferences managed by this manager.
	 */
<span class="fc" id="L104">	@SharedPreferencesPolicy.Mode</span>
	private int mPreferencesMode = SharedPreferencesPolicy.MODE_PRIVATE;

	/**
	 * Facade to which is this manager delegating all put/get/remove requests.
	 */
	private SimpleSharedPreferencesFacade mPreferencesFacade;

	/**
	 * Flag indicating whether caching of the actual values of each shared preference is enabled.
	 * This means that, if shared preference holds actual value which is same as in shared preferences,
	 * parsing of that value will be not performed, instead actual value will be obtained from that
	 * preference object.
	 */
	private boolean mCachingEnabled;

	/*
	 * Constructors ================================================================================
	 */

	/**
	 * Creates a new instance of PreferencesManager with the specified &lt;var&gt;context&lt;/var&gt;.
	 * &lt;p&gt;
	 * Manager will be created with default name for shared preferences obtained via
	 * {@link SharedPreferencesPolicy#defaultPreferencesName(Context)} and mode set to
	 * {@link SharedPreferencesPolicy#MODE_PRIVATE}.
	 *
	 * @param context Context that is used to obtain instance of {@link SharedPreferences} for the
	 *                new manager via {@link Context#getSharedPreferences(String, int)} for the
	 *                {@code name} and {@code mode} specified via {@link #setSharedPreferencesName(String)}
	 *                and {@link #setSharedPreferencesMode(int)}.
	 */
<span class="fc" id="L136">	public PreferencesManager(@NonNull Context context) {</span>
<span class="fc" id="L137">		this.mContext = context;</span>
<span class="fc" id="L138">		this.mPreferencesName = SharedPreferencesPolicy.defaultPreferencesName(context);</span>

<span class="fc" id="L140">	}</span>

	/*
	 * Methods =====================================================================================
	 */

	/**
	 * Returns the context with which has been this manager created.
	 *
	 * @return The associated context.
	 */
	@NonNull
	public final Context getContext() {
<span class="fc" id="L153">		return mContext;</span>
	}

	/**
	 */
	@Override
	public void setSharedPreferencesName(@Nullable String name) {
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">		this.mPreferencesName = name == null ? SharedPreferencesPolicy.defaultPreferencesName(mContext) : name;</span>
<span class="fc" id="L161">		this.mPreferencesFacade = null;</span>
<span class="fc" id="L162">	}</span>

	/**
	 */
	@NonNull
	@Override
	public final String getSharedPreferencesName() {
<span class="fc" id="L169">		return mPreferencesName;</span>
	}

	/**
	 */
	@Override
	public void setSharedPreferencesMode(@SharedPreferencesPolicy.Mode int mode) {
<span class="fc" id="L176">		this.mPreferencesMode = mode;</span>
<span class="fc" id="L177">		this.mPreferencesFacade = null;</span>
<span class="fc" id="L178">	}</span>

	/**
	 */
	@Override
	@SharedPreferencesPolicy.Mode
	public final int getSharedPreferencesMode() {
<span class="fc" id="L185">		return mPreferencesMode;</span>
	}

	/**
	 */
	@NonNull
	@Override
	public final SharedPreferences getSharedPreferences() {
<span class="fc" id="L193">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L194">		return mPreferencesFacade.getPreferences();</span>
	}

	/**
	 * Ensures that the {@link #mPreferencesFacade} for {@link SharedPreferences} managed by this
	 * manager is initialized for {@link #mPreferencesName} and {@link #mPreferencesMode}.
	 */
	private void ensurePreferencesFacade() {
<span class="fc bfc" id="L202" title="All 2 branches covered.">		if (mPreferencesFacade == null) {</span>
<span class="fc" id="L203">			this.mPreferencesFacade = new SimpleSharedPreferencesFacade(</span>
<span class="fc" id="L204">					mContext.getSharedPreferences(</span>
							mPreferencesName,
							mPreferencesMode
					)
			);
		}
<span class="fc" id="L210">	}</span>

	/**
	 * Enables/disables the caching {@link universum.studios.android.preference.SharedPreference}'s values.
	 *
	 * @param enabled {@code True} to enable caching, {@code false} to disable.
	 * @see #isCachingEnabled()
	 */
	public final void setCachingEnabled(final boolean enabled) {
<span class="fc" id="L219">		this.mCachingEnabled = enabled;</span>
<span class="fc" id="L220">	}</span>

	/**
	 * Returns flag indicating whether the caching of {@link universum.studios.android.preference.SharedPreference}'s
	 * values is enabled or not.
	 *
	 * @return {@code True} if caching is enabled, {@code false} otherwise.
	 * @see #setCachingEnabled(boolean)
	 */
	public final boolean isCachingEnabled() {
<span class="fc" id="L230">		return mCachingEnabled;</span>
	}

	/**
	 * Returns a string key for the specified &lt;var&gt;resId&lt;/var&gt;.
	 *
	 * @param resId Resource id of the desired preference key.
	 * @return String key obtained from the context specified for this manager.
	 */
	@NonNull
	public final String key(@StringRes final int resId) {
<span class="fc" id="L241">		return mContext.getString(resId);</span>
	}

	/**
	 */
	@Override
	public void registerOnSharedPreferenceChangeListener(@NonNull SharedPreferences.OnSharedPreferenceChangeListener listener) {
<span class="fc" id="L248">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L249">		mPreferencesFacade.registerOnSharedPreferenceChangeListener(listener);</span>
<span class="fc" id="L250">	}</span>

	/**
	 */
	@Override
	public void unregisterOnSharedPreferenceChangeListener(@NonNull SharedPreferences.OnSharedPreferenceChangeListener listener) {
<span class="fc" id="L256">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L257">		mPreferencesFacade.unregisterOnSharedPreferenceChangeListener(listener);</span>
<span class="fc" id="L258">	}</span>

	/**
	 */
	@Override
	public boolean contains(@NonNull String key) {
<span class="fc" id="L264">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L265">		return mPreferencesFacade.contains(key);</span>
	}

	/**
	 */
	@Override
	public boolean putString(@NonNull String key, @Nullable String value) {
<span class="fc" id="L272">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L273">		return mPreferencesFacade.putString(key, value);</span>
	}

	/**
	 */
	@Nullable
	@Override
	public String getString(@NonNull String key, @Nullable String defValue) {
<span class="fc" id="L281">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L282">		return mPreferencesFacade.getString(key, defValue);</span>
	}

	/**
	 */
	@Override
	public boolean putStringSet(@NonNull String key, @Nullable Set&lt;String&gt; values) {
<span class="fc" id="L289">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L290">		return mPreferencesFacade.putStringSet(key, values);</span>
	}

	/**
	 */
	@Nullable
	@Override
	public Set&lt;String&gt; getStringSet(@NonNull String key, @Nullable Set&lt;String&gt; defValues) {
<span class="fc" id="L298">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L299">		return mPreferencesFacade.getStringSet(key, defValues);</span>
	}

	/**
	 */
	@Override
	public boolean putInt(@NonNull String key, int value) {
<span class="fc" id="L306">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L307">		return mPreferencesFacade.putInt(key, value);</span>
	}

	/**
	 */
	@Override
	public int getInt(@NonNull String key, int defValue) {
<span class="fc" id="L314">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L315">		return mPreferencesFacade.getInt(key, defValue);</span>
	}

	/**
	 */
	@Override
	public boolean putFloat(@NonNull String key, float value) {
<span class="fc" id="L322">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L323">		return mPreferencesFacade.putFloat(key, value);</span>
	}

	/**
	 */
	@Override
	public float getFloat(@NonNull String key, float defValue) {
<span class="fc" id="L330">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L331">		return mPreferencesFacade.getFloat(key, defValue);</span>
	}

	/**
	 */
	@Override
	public boolean putLong(@NonNull String key, long value) {
<span class="fc" id="L338">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L339">		return mPreferencesFacade.putLong(key, value);</span>
	}

	/**
	 */
	@Override
	public long getLong(@NonNull String key, long defValue) {
<span class="fc" id="L346">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L347">		return mPreferencesFacade.getLong(key, defValue);</span>
	}

	/**
	 */
	@Override
	public boolean putBoolean(@NonNull String key, boolean value) {
<span class="fc" id="L354">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L355">		return mPreferencesFacade.putBoolean(key, value);</span>
	}

	/**
	 */
	@Override
	public boolean getBoolean(@NonNull String key, boolean defValue) {
<span class="fc" id="L362">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L363">		return mPreferencesFacade.getBoolean(key, defValue);</span>
	}

	/**
	 */
	@Override
	public boolean remove(@NonNull String key) {
<span class="fc" id="L370">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L371">		return mPreferencesFacade.remove(key);</span>
	}

	/**
	 */
	@Override
	public int removeAll() {
<span class="fc" id="L378">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L379">		return mPreferencesFacade.removeAll();</span>
	}

	/**
	 * Persists the given &lt;var&gt;value&lt;/var&gt; for the specified &lt;var&gt;preference&lt;/var&gt; into {@link SharedPreferences}
	 * that are managed by this manager.
	 *
	 * @param preference Preference for which to persist the value.
	 * @param value      The value to be persisted.
	 * @param &lt;T&gt;        Type of the value associated with the preference.
	 * @return {@code True} if put has been successful, {@code false} otherwise.
	 * @see #getPreference(SharedPreference)
	 * @see #containsPreference(SharedPreference)
	 * @see #removePreference(SharedPreference)
	 * @see SharedPreference#updateValue(Object)
	 * @see SharedPreference#putIntoPreferences(SharedPreferences)
	 */
	public final &lt;T&gt; boolean putPreference(@NonNull final SharedPreference&lt;T&gt; preference, @Nullable final T value) {
<span class="fc" id="L397">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L398">		final boolean result = preference.updateValue(value).putIntoPreferences(mPreferencesFacade.getPreferences());</span>
<span class="fc bfc" id="L399" title="All 2 branches covered.">		if (!mCachingEnabled) {</span>
<span class="fc" id="L400">			preference.invalidate();</span>
		}
<span class="fc" id="L402">		return result;</span>
	}

	/**
	 * Obtains the value for the given &lt;var&gt;preference&lt;/var&gt; from {@link SharedPreferences} that are
	 * managed by this manager.
	 *
	 * @param preference Preference for which to obtain its associated value.
	 * @param &lt;T&gt;        Type of the value associated with the preference.
	 * @return Value associated with the preference. May be {@code null} if there is no value persisted
	 * for the preference yet.
	 * @see #putPreference(SharedPreference, Object)
	 * @see #contains(String)
	 * @see SharedPreference#getFromPreferences(SharedPreferences)
	 */
	@Nullable
	public final &lt;T&gt; T getPreference(@NonNull final SharedPreference&lt;T&gt; preference) {
<span class="fc" id="L419">		this.ensurePreferencesFacade();</span>
<span class="fc" id="L420">		final T value = preference.getFromPreferences(mPreferencesFacade.getPreferences());</span>
<span class="fc bfc" id="L421" title="All 2 branches covered.">		if (!mCachingEnabled) {</span>
<span class="fc" id="L422">			preference.invalidate();</span>
		}
<span class="fc" id="L424">		return value;</span>
	}

	/**
	 * Checks whether there is value associated with the specified &lt;var&gt;preference&lt;/var&gt; contained
	 * within {@link SharedPreferences} that are managed by this manager.
	 *
	 * @param preference The desired preference of which value's presence to check.
	 * @return {@code True} if there is value contained for key of the specified preference,
	 * {@code false} otherwise.
	 * @see #putPreference(SharedPreference, Object)
	 * @see #getPreference(SharedPreference)
	 * @see #removePreference(SharedPreference)
	 */
	public final boolean containsPreference(@NonNull final SharedPreference preference) {
<span class="fc" id="L439">		return contains(preference.getKey());</span>
	}

	/**
	 * Removes a value for the specified &lt;var&gt;preference&lt;/var&gt; from {@link SharedPreferences} that
	 * are managed by this manager.
	 *
	 * @param preference The preference for which to remove its associated value.
	 * @return {@code True} if removal has been successful, {@code false} otherwise.
	 * @see #putPreference(SharedPreference, Object)
	 * @see #getPreference(SharedPreference)
	 * @see #containsPreference(SharedPreference)
	 */
	public final boolean removePreference(@NonNull final SharedPreference preference) {
<span class="fc" id="L453">		return remove(preference.getKey());</span>
	}

	/*
	 * Inner classes ===============================================================================
	 */
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span>Generated by the Android Gradle plugin 2.3.1</div></body></html>